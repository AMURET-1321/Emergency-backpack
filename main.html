<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜²ç½ãƒãƒƒã‚°ãƒ‘ãƒƒã‚«ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* (æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«...å¤‰æ›´ãªã—) */
        :root {
            /* JSã§å‹•çš„ã«è¨­å®šã•ã‚Œã¾ã™ */
            --grid-cols: 10;
            --grid-rows: 12; 
            --cell-size: 30px; 
            --bag-width: calc(var(--grid-cols) * var(--cell-size));
            --bag-height: calc(var(--grid-rows) * var(--cell-size));
            --bag-color: #38404a; /* ãƒãƒƒã‚°ã®å¸ƒåœ°è‰² (ãƒ€ãƒ¼ã‚¯ãƒã‚¤ãƒ“ãƒ¼ã«è¿‘ã„) */
            --bag-inner-color: #e0e4e8; /* ãƒãƒƒã‚°ã®å†…éƒ¨è‰² (æ˜ã‚‹ã„ã‚°ãƒ¬ãƒ¼) */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* light gray */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 10vh;
            padding: 20px;
        }

        #game-container {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- ãƒãƒƒã‚°ã®å¤–æ ã¨è£…é£¾ (é„å‹) --- */
        #bag-area {
            position: relative;
            margin-bottom: 20px;
            padding-top: 60px;
        }

        #bag-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: calc(var(--bag-width) + 16px);
            height: 60px;
            background-color: var(--bag-color); 
            border-radius: 25px 25px 5px 5px; 
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            z-index: 5;
            border: 4px solid #1a202c;
        }

        #bag-area::after {
            content: 'ğŸ’'; 
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2.5rem; 
            z-index: 10;
            cursor: default;
        }
        /* ------------------------------------ */


        #bag {
            width: var(--bag-width);
            height: var(--bag-height);
            border: 8px solid #2a3038;
            position: relative;
            
            box-shadow: 
                inset 0 0 25px rgba(0, 0, 0, 0.7),
                0 15px 25px rgba(0, 0, 0, 0.3);
            
            border-radius: 15px 15px 80px 80px; 
            overflow: hidden;
            
            background: linear-gradient(180deg, var(--bag-inner-color) 0%, #c4c9cd 100%);
        }

        .grid-cell {
            position: absolute;
            width: var(--cell-size);
            height: var(--cell-size);
            box-sizing: border-box;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: background-color 0.2s;
            z-index: 3;
        }

        .grid-cell.item {
            border: 1px solid rgba(0, 0, 0, 0.2);
            transition: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 2;
        }

        /* ã‚¢ã‚¤ãƒ†ãƒ è¡¨ç¤ºã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #next-item-preview {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            width: 100%;
        }

        .piece-cell {
            width: var(--cell-size);
            height: var(--cell-size);
            display: inline-block;
            box-sizing: border-box;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        /* ãƒ”ãƒ¼ã‚¹ã®ã‚³ãƒ³ãƒ†ãƒŠ (ãƒ•ãƒ¬ã‚­ã‚·ãƒ–ãƒ«ãªé…ç½®ã‚’å¯èƒ½ã«ã™ã‚‹ãŸã‚) */
        .piece-container {
            grid-gap: 0; 
            display: inline-grid;
            grid-template-columns: repeat(5, var(--cell-size)); 
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="p-4 bg-gray-100">

<div id="game-container" class="flex flex-col items-center p-4 bg-white rounded-xl shadow-2xl">
    <h1 class="text-3xl font-bold mb-4 text-gray-800">ğŸ’ é˜²ç½ãƒãƒƒã‚°ãƒ‘ãƒƒã‚«ãƒ¼ (æ•™è‚²ç‰ˆ)</h1>

    <!-- è¨­å®šç”»é¢ -->
    <div id="settings-screen" class="w-full max-w-lg p-6 bg-gray-50 rounded-lg shadow-inner">
        <h2 class="text-2xl font-bold mb-4 text-gray-700">ã‚²ãƒ¼ãƒ è¨­å®š</h2>
        
        <!-- ã‚·ãƒŠãƒªã‚ªé¸æŠ -->
        <div class="mb-6">
            <label class="block text-lg font-semibold mb-2 text-gray-700" for="scenario-select">1. ã‚·ãƒŠãƒªã‚ªã‚’é¸æŠ</label>
            <p class="text-sm text-gray-500 mb-2">é¸æŠã—ãŸã‚·ãƒŠãƒªã‚ªã§ã‚¢ã‚¤ãƒ†ãƒ ã®**é‡è¦åº¦**ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚</p>
            <select id="scenario-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-150">
                <!-- Options will be populated by JS -->
            </select>
        </div>
        
        <!-- å­£ç¯€ã‚’é¸æŠ -->
        <div class="mb-6">
            <label class="block text-lg font-semibold mb-2 text-gray-700" for="season-select">1.5. å­£ç¯€ã‚’é¸æŠ</label>
            <p class="text-sm text-gray-500 mb-2">å­£ç¯€ã«ã‚ˆã£ã¦ã‚‚ã‚¢ã‚¤ãƒ†ãƒ ã®é‡è¦åº¦ãŒå¤‰å‹•ã—ã¾ã™ã€‚</p>
            <select id="season-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150">
                </select>
        </div>
        
        <!-- é›£æ˜“åº¦é¸æŠ -->
        <div class="mb-6">
            <label class="block text-lg font-semibold mb-2 text-gray-700">2. é›£æ˜“åº¦ï¼ˆãƒãƒƒã‚°ã‚µã‚¤ã‚ºï¼‰ã‚’é¸æŠ</label>
            <div id="difficulty-options" class="flex flex-col space-y-2">
                <!-- Radios will be populated by JS -->
            </div>
        </div>

        <button id="start-game-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-xl transition duration-300 transform hover:scale-[1.01]">
            ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ
        </button>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ç”»é¢ -->
    <div id="game-screen" class="hidden w-full flex flex-col items-center">
        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
        <div class="w-full max-w-lg mb-4 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400">
            <div class="text-sm text-gray-600 mb-1">
                ã‚·ãƒŠãƒªã‚ª: <span id="current-scenario" class="font-bold text-purple-600"></span> / 
                å­£ç¯€: <span id="current-season" class="font-bold text-indigo-600"></span> / 
                é›£æ˜“åº¦: <span id="current-difficulty" class="font-bold text-blue-600"></span>
                </div>
            <div class="text-xl font-semibold text-gray-700">
                ã‚¹ã‚³ã‚¢ (é‡è¦åº¦åˆè¨ˆ): <span id="score" class="text-green-600 text-2xl">0</span>
            </div>
            <button id="restart-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 mt-3 hidden">
                ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ (è¨­å®šç”»é¢ã¸)
            </button>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ãƒãƒƒã‚°ã‚¨ãƒªã‚¢ -->
        <div id="bag-area" class="flex flex-col items-center">
            <div id="bag">
                <!-- ã‚°ãƒªãƒƒãƒ‰ã‚»ãƒ«ã¯JSã§æç”»ã•ã‚Œã¾ã™ -->
            </div>
        </div>

        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
        <div id="message" class="mt-4 text-center font-bold h-6 text-gray-600">
            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯JSã§æ›´æ–°ã•ã‚Œã¾ã™ -->
        </div>

        <!-- æ¬¡ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚¨ãƒªã‚¢ -->
        <div class="mt-6 p-4 bg-gray-50 rounded-xl shadow-inner w-full max-w-lg">
            <h2 class="text-xl font-semibold mb-3 text-gray-700">
                æ¬¡ã®ã‚¢ã‚¤ãƒ†ãƒ : <span id="next-item-name" class="text-purple-600"></span> 
                (<span id="dynamic-importance" class="font-bold"></span>)
            </h2>
            <div id="next-item-preview" class="border border-gray-300 rounded-lg p-2 h-20">
                <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯JSã§æç”»ã•ã‚Œã¾ã™ -->
            </div>
            
            <!-- æ–°ã—ã„èª¬æ˜ã‚¨ãƒªã‚¢ -->
            <div id="item-details" class="mt-4 p-3 bg-white rounded-lg border-l-4 border-purple-400 shadow-sm">
                <p class="text-sm font-semibold text-gray-700">ç”¨é€”:</p>
                <p id="item-description" class="text-base text-gray-800 mb-2"></p>
                <p class="text-sm font-semibold text-gray-700">æ ¹æ‹ :</p>
                <p id="item-rationale" class="text-xs text-blue-500 italic"></p>
            </div>

            <!-- ã‚¢ã‚¤ãƒ†ãƒ é¸æŠè‚¢ã‚¨ãƒªã‚¢ -->
            <div id="choice-area" class="mt-4 flex flex-wrap justify-center space-x-2 sm:space-x-4">
                <!-- ãƒœã‚¿ãƒ³ã¯JSã§æŒ¿å…¥ã•ã‚Œã¾ã™ -->
            </div>
        </div>
    </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« (ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ) -->
<div id="report-modal" class="modal hidden">
    <div class="modal-content w-full sm:w-3/4 lg:w-1/2">
        <h2 class="text-3xl font-bold mb-4 text-red-600 text-center">ğŸš¨ ãƒ‘ãƒƒã‚­ãƒ³ã‚°çµ‚äº†ãƒ¬ãƒãƒ¼ãƒˆ ğŸš¨</h2>
        <hr class="mb-4">
        
        <div class="mb-6 p-4 bg-yellow-50 rounded-lg">
            <p class="text-lg font-semibold text-gray-800">
                ç›®æ¨™ã‚·ãƒŠãƒªã‚ª: <span id="report-scenario" class="text-purple-600"></span> 
                (<span id="report-season" class="text-indigo-600"></span>)
                </p>
            <p class="text-lg font-semibold text-gray-800">
                æœ€çµ‚ã‚¹ã‚³ã‚¢: <span id="report-final-score" class="text-green-600 text-2xl">0</span>
            </p>
        </div>

        <div id="report-achievment" class="text-center mb-6">
            <!-- é”æˆåº¦ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ãŒã“ã“ã«å…¥ã‚‹ -->
        </div>

        <h3 class="text-xl font-bold mb-3 text-gray-700 border-b pb-1">ğŸ—‚ï¸ æ”¹å–„ç‚¹ã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h3>
        <div id="feedback-content">
            <!-- ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ã¯JSã§ç”Ÿæˆã•ã‚Œã‚‹ -->
        </div>

        <button id="close-report-button" class="w-full mt-8 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-xl transition duration-300">
            è¨­å®šç”»é¢ã«æˆ»ã‚‹
        </button>
    </div>
</div>

<script type="module">
    // ã‚°ãƒªãƒƒãƒ‰è¨­å®š (åˆæœŸå€¤)
    let GRID_COLS = 10;
    let GRID_ROWS = 12; 
    const CELL_SIZE = 30; 
    const MIN_REQUIRED_IMPORTANCE = 10; // æ¡ç‚¹ãƒ¬ãƒãƒ¼ãƒˆã§ã€Œå¿…é ˆã€ã¨è¦‹ãªã™ãƒ™ãƒ¼ã‚¹ã®é‡è¦åº¦

    // ã‚²ãƒ¼ãƒ å¤‰æ•°
    let grid = []; // 0:ç©º, >0:ã‚¢ã‚¤ãƒ†ãƒ ID
    let placedItems = []; // è©°ã‚ãŸã‚¢ã‚¤ãƒ†ãƒ ã®ãƒªã‚¹ãƒˆ (ãƒ¬ãƒãƒ¼ãƒˆç”¨)
    let score = 0;
    let isGameOver = false;
    let currentPiece = null;
    let currentPieceId = 0; // è©°ã‚ãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’è­˜åˆ¥ã™ã‚‹ãŸã‚ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ID
    let currentPlacement = { row: -1, col: -1 };
    
    // ã‚·ãƒŠãƒªã‚ª/é›£æ˜“åº¦è¨­å®šå¤‰æ•°
    let selectedScenario = 'default';
    let selectedDifficulty = 'medium';
    let selectedSeason = 'spring'; 

    // DOMè¦ç´ 
    const settingsScreen = document.getElementById('settings-screen');
    const gameScreen = document.getElementById('game-screen');
    const bagElement = document.getElementById('bag');
    const scoreElement = document.getElementById('score');
    const messageElement = document.getElementById('message');
    const nextItemPreviewElement = document.getElementById('next-item-preview');
    const nextItemNameElement = document.getElementById('next-item-name');
    const dynamicImportanceElement = document.getElementById('dynamic-importance');
    const itemDescriptionElement = document.getElementById('item-description');
    const itemRationaleElement = document.getElementById('item-rationale');
    const restartButton = document.getElementById('restart-button');
    const choiceAreaElement = document.getElementById('choice-area');
    const startGameButton = document.getElementById('start-game-button');
    const scenarioSelect = document.getElementById('scenario-select');
    const difficultyOptions = document.getElementById('difficulty-options');
    const currentScenarioDisplay = document.getElementById('current-scenario');
    const currentDifficultyDisplay = document.getElementById('current-difficulty');
    const seasonSelect = document.getElementById('season-select');
    const currentSeasonDisplay = document.getElementById('current-season');
    const reportSeason = document.getElementById('report-season');
    const reportModal = document.getElementById('report-modal');
    const closeReportButton = document.getElementById('close-report-button');
    const reportAchievment = document.getElementById('report-achievment');
    const feedbackContent = document.getElementById('feedback-content');
    const reportScenario = document.getElementById('report-scenario');
    const reportFinalScore = document.getElementById('report-final-score');


    // --- è¨­å®šãƒ‡ãƒ¼ã‚¿ ---

    // é›£æ˜“åº¦è¨­å®š: ãƒãƒƒã‚°ã®ã‚µã‚¤ã‚º
    const DIFFICULTY_SETTINGS = {
        'easy': { name: "ç°¡å˜ (å¤§å®¹é‡)", cols: 12, rows: 15 }, 
        'medium': { name: "æ¨™æº– (ä¸­å®¹é‡)", cols: 10, rows: 12 }, 
        'hard': { name: "é›£è§£ (å°å®¹é‡)", cols: 8, rows: 10 }
    };

    // ã‚·ãƒŠãƒªã‚ªè¨­å®š: ã‚¢ã‚¤ãƒ†ãƒ ã®é‡è¦åº¦ã«ã‹ã‹ã‚‹ä¹—æ•° (multiplier) ã‚’å®šç¾©
    const SCENARIOS = {
        'default': { name: "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ (ãƒãƒ©ãƒ³ã‚¹)", modifiers: {} },
        'earthquake': { 
            name: "åœ°éœ‡ç™ºç”Ÿ (æºã‚Œ)", 
            modifiers: {
                "æ•‘æ€¥ã‚»ãƒƒãƒˆ": 1.5,
                "æ‡ä¸­é›»ç¯": 1.3,
                "ãƒãƒ³ã‚¬ (å…¨å·»)": 0.2 // é¿é›£æ‰€ç”Ÿæ´»ã®ã‚¹ãƒˆãƒ¬ã‚¹å¯¾ç­–ã¨ã—ã¦å°‘ã—ã ã‘ä¾¡å€¤ã‚’æ®‹ã™
            }
        },
        'heavy_rain': { 
            name: "è±ªé›¨ãƒ»æ°´å®³", 
            modifiers: {
                "æ°´ (2L)": 1.5,
                "é˜²å¯’ç€/æ¯›å¸ƒ": 1.5, // æ¿¡ã‚ŒãŸå¾Œã®ä½ä½“æ¸©ç—‡å¯¾ç­–
                "ç¾å®¹å®¶é›» (ãƒ˜ã‚¢ã‚¢ã‚¤ãƒ­ãƒ³ç­‰)": 0.1
            }
        },
        'power_outage': { 
            name: "é•·æœŸåœé›»", 
            modifiers: {
                "ãƒ©ã‚¸ã‚ª/ãƒ¢ãƒã‚¤ãƒ«ãƒãƒƒãƒ†ãƒªãƒ¼": 2.2,
                "æ‡ä¸­é›»ç¯": 1.8,
                "ã‚²ãƒ¼ãƒ æ©Ÿæœ¬ä½“": 0.0 // å……é›»æ‰‹æ®µãŒãªã„ã¨ç„¡ä¾¡å€¤
            }
        },
        'winter_evacuation': { 
            name: "å†¬å­£é¿é›£", 
            modifiers: {
                "é˜²å¯’ç€/æ¯›å¸ƒ": 2.5,
                "éå¸¸é£Ÿ (3æ—¥åˆ†)": 1.3,
                "å¤§ããªã¬ã„ãã‚‹ã¿": 0.5 // æš–ã‚’ã¨ã‚‹ç”¨é€”ã¨ã—ã¦ã‚ãšã‹ã«ä¾¡å€¤ã‚’ä»˜ä¸
            }
        }
    };
    
    // ã‚·ãƒŠãƒªã‚ªã¨ã¯åˆ¥ã«ä¹—ç®—ã•ã‚Œã‚‹ä¿®æ­£å­
    const SEASONS = {
        'spring': { 
            name: "æ˜¥", 
            modifiers: {
                "æ•‘æ€¥ã‚»ãƒƒãƒˆ": 1.1, // èŠ±ç²‰ç—‡ã‚„æ€ªæˆ‘
                "æ°´ (2L)": 1.1 // æš–ã‹ããªã£ã¦ãã‚‹
            }
        },
        'summer': { 
            name: "å¤", 
            modifiers: {
                "æ°´ (2L)": 1.8, // è„±æ°´å¯¾ç­–
                "é˜²å¯’ç€/æ¯›å¸ƒ": 0.5, // å„ªå…ˆåº¦ä½ä¸‹
                "ç¾å®¹å®¶é›» (ãƒ˜ã‚¢ã‚¢ã‚¤ãƒ­ãƒ³ç­‰)": 0.2
            }
        },
        'autumn': { 
            name: "ç§‹", 
            modifiers: {
                "éå¸¸é£Ÿ (3æ—¥åˆ†)": 1.1, // é£Ÿæ–™ç¢ºä¿
                "é˜²å¯’ç€/æ¯›å¸ƒ": 1.2 // å¯’æš–å·®å¯¾ç­–
            }
        },
        'winter': { 
            name: "å†¬", 
            modifiers: {
                "é˜²å¯’ç€/æ¯›å¸ƒ": 2.0, // å¿…é ˆ
                "éå¸¸é£Ÿ (3æ—¥åˆ†)": 1.2, // ã‚«ãƒ­ãƒªãƒ¼æ¶ˆè²»
                "æ°´ (2L)": 0.9 // å¤ã‚ˆã‚Šã¯å„ªå…ˆåº¦ä½ä¸‹
            }
        }
    };

    // ã‚¢ã‚¤ãƒ†ãƒ å®šç¾© (ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹é‡è¦åº¦ã€å½¢çŠ¶ã€èª¬æ˜)
    // category: ãƒ¬ãƒãƒ¼ãƒˆä½œæˆã®ãŸã‚ã®åˆ†é¡
    const BASE_ITEMS = [
        { name: "æ°´ (2L)", importance: 25, shape: [[0, 0], [1, 0], [2, 0], [3, 0], [0, 1], [1, 1], [2, 1]], color: "#3182ce", description: "é£²ã¿æ°´ã€èª¿ç†ã€è¡›ç”Ÿç”¨ã€‚", rationale: "1äºº1æ—¥3Lã‚’ç›®å®‰ã«3æ—¥åˆ†ã€‚æœ€é‡è¦ã€‚", category: "LifeSupport" },
        { name: "éå¸¸é£Ÿ (3æ—¥åˆ†)", importance: 20, shape: [[0, 0], [0, 1], [0, 2], [1, 0], [1, 1], [1, 2]], color: "#dd6b20", description: "æœ€ä½é™ã®ã‚«ãƒ­ãƒªãƒ¼ã¨æ „é¤Šç¢ºä¿ã€‚", rationale: "ã‚¢ãƒ«ãƒ•ã‚¡ç±³ã‚„ç¼¶è©°ãªã©ã€èª¿ç†ä¸è¦ãªã‚‚ã®ã‚’ä¸­å¿ƒã«ã€‚", category: "LifeSupport" },
        { name: "ãƒ©ã‚¸ã‚ª/ãƒ¢ãƒã‚¤ãƒ«ãƒãƒƒãƒ†ãƒªãƒ¼", importance: 18, shape: [[0, 1], [1, 0], [1, 1], [1, 2], [2, 1]], color: "#ecc94b", description: "æƒ…å ±åé›†ã¨é€šä¿¡æ‰‹æ®µã®ç¢ºä¿ã€‚", rationale: "æ‰‹å›ã—å……é›»å¼ã‚„å¤§å®¹é‡ãƒãƒƒãƒ†ãƒªãƒ¼ãŒã‚ã‚Œã°å®‰å¿ƒã€‚", category: "Information" },
        { name: "é˜²å¯’ç€/æ¯›å¸ƒ", importance: 15, shape: [[0, 0], [1, 0], [2, 0], [2, 1]], color: "#9f7aea", description: "ä½ä½“æ¸©ç—‡ã®äºˆé˜²ã¨ä½“æ¸©ç¶­æŒã€‚", rationale: "è–„ã„é˜²å¯’å…·ã¯é‡ã­ç€ã«ä¾¿åˆ©ã€‚ã‚¢ãƒ«ãƒŸã‚·ãƒ¼ãƒˆã‚‚æ¨å¥¨ã€‚", category: "Survival" },
        { name: "æ‡ä¸­é›»ç¯", importance: 12, shape: [[0, 0], [0, 1], [0, 2], [0, 3]], color: "#f6ad55", description: "å¤œé–“ã®ç§»å‹•ã‚„çŠ¶æ³ç¢ºèªç”¨ã€‚", rationale: "LEDå¼ã§äºˆå‚™é›»æ± ã¾ãŸã¯å……é›»å¼ãŒå¿…é ˆã€‚ä¸¡æ‰‹ãŒç©ºããƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒˆãŒç†æƒ³ã€‚", category: "Information" },
        { name: "æ•‘æ€¥ã‚»ãƒƒãƒˆ", importance: 10, shape: [[0, 0], [1, 0], [2, 0]], color: "#48bb78", description: "æ€ªæˆ‘ã‚„æŒç—…ã®å¿œæ€¥å‡¦ç½®ã€‚", rationale: "å¸¸å‚™è–¬ã€æ¶ˆæ¯’æ¶²ã€çµ†å‰µè†ãªã©ã€‚æœ€ä½é™ã®æ­¢è¡€é“å…·ã¯å¿…è¦ã€‚", category: "Survival" },
        
        // ä¸è¦/æµªè²»ã‚¢ã‚¤ãƒ†ãƒ 
        { name: "ãƒãƒ³ã‚¬ (å…¨å·»)", importance: 4, shape: [[0, 0], [1, 0], [2, 0], [3, 0], [0, 1]], color: "#718096", description: "é¿é›£æ‰€ã§ã®æš‡ã¤ã¶ã—ã€‚", rationale: "å®¹é‡ã‚’å¤šãæ¶ˆè²»ã™ã‚‹å‰²ã«ã€ç”Ÿå­˜ã«å¿…é ˆã§ã¯ãªã„ã€‚", category: "NonEssential" },
        { name: "å¤§ããªã¬ã„ãã‚‹ã¿", importance: 2, shape: [[0, 0], [0, 1], [1, 0], [1, 1]], color: "#a0aec0", description: "ç²¾ç¥çš„ãªå®‰å®šç”¨ã€‚", rationale: "å­ä¾›ã«ã¨ã£ã¦ã¯é‡è¦ã ãŒã€ä½“ç©ãŒéå¸¸ã«å¤§ãã„ã€‚", category: "NonEssential" },
        { name: "ç¾å®¹å®¶é›» (ãƒ˜ã‚¢ã‚¢ã‚¤ãƒ­ãƒ³ç­‰)", importance: -5, shape: [[0, 0], [0, 1], [0, 2]], color: "#d53f8c", description: "èº«ã ã—ãªã¿ç¶­æŒç”¨ã€‚", rationale: "é›»æ°—ã®ç¢ºä¿ãŒå›°é›£ãªçŠ¶æ³ã§ã¯ä½¿ç”¨ã§ããšã€ã‚¹ãƒšãƒ¼ã‚¹ã®ç„¡é§„ã€‚", category: "Waste" },
        { name: "ã‚²ãƒ¼ãƒ æ©Ÿæœ¬ä½“", importance: -8, shape: [[0, 0], [1, 0], [0, 1], [1, 1]], color: "#e53e3e", description: "å¨¯æ¥½ç”¨ã€‚", rationale: "å……é›»ãŒåˆ‡ã‚Œã‚Œã°ä½¿ãˆãšã€é‡ã„ã€‚å„ªå…ˆåº¦ã¯æ¥µã‚ã¦ä½ã„ã€‚", category: "Waste" },
        { name: "ã‚´ãƒ«ãƒ•ãƒœãƒ¼ãƒ«", importance: 1, shape: [[0, 0]], color: "#ffffff", description: "ã‚¹ãƒˆãƒ¬ã‚¹è§£æ¶ˆç”¨ã€‚", rationale: "å°ã•ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’åŸ‹ã‚ã‚‹ã®ã«ã¯ä½¿ãˆã‚‹ãŒã€ã»ã¼ç„¡æ„å‘³ã€‚", category: "NonEssential" },
    ];

    // --- åˆæœŸè¨­å®šç”»é¢ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---

    /**
     * åˆæœŸè¨­å®šç”»é¢ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
     */
    function loadSettingsUI() {
        // ã‚·ãƒŠãƒªã‚ªé¸æŠè‚¢ã®ãƒ­ãƒ¼ãƒ‰
        scenarioSelect.innerHTML = '';
        for (const key in SCENARIOS) {
            const scenario = SCENARIOS[key];
            const option = document.createElement('option');
            option.value = key;
            option.textContent = scenario.name;
            scenarioSelect.appendChild(option);
        }
        scenarioSelect.value = selectedScenario;
        
        seasonSelect.innerHTML = '';
        for (const key in SEASONS) {
            const season = SEASONS[key];
            const option = document.createElement('option');
            option.value = key;
            option.textContent = season.name;
            seasonSelect.appendChild(option);
        }
        seasonSelect.value = selectedSeason;

        // é›£æ˜“åº¦ï¼ˆãƒãƒƒã‚°ã‚µã‚¤ã‚ºï¼‰ã®ãƒ­ãƒ¼ãƒ‰
        difficultyOptions.innerHTML = '';
        for (const key in DIFFICULTY_SETTINGS) {
            const setting = DIFFICULTY_SETTINGS[key];
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'difficulty';
            radio.id = `diff-${key}`;
            radio.value = key;
            radio.className = 'mr-2 text-purple-600 focus:ring-purple-500';
            if (key === selectedDifficulty) {
                radio.checked = true;
            }

            const label = document.createElement('label');
            label.htmlFor = `diff-${key}`;
            label.className = 'font-medium text-gray-600 cursor-pointer p-2 block border border-gray-200 rounded-lg bg-white hover:bg-gray-100';
            label.textContent = `${setting.name} (${setting.cols}x${setting.rows})`;

            const div = document.createElement('div');
            div.className = 'flex items-center';
            div.appendChild(radio);
            div.appendChild(label);
            difficultyOptions.appendChild(div);
        }
    }

    /**
     * ã‚²ãƒ¼ãƒ ã‚’åˆæœŸåŒ–ã—ã€ã‚²ãƒ¼ãƒ ç”»é¢ã¸åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚
     */
    function initGame() {
        // 1. è¨­å®šå€¤ã®å–å¾—ã¨é©ç”¨
        selectedScenario = scenarioSelect.value;
        selectedSeason = seasonSelect.value;
        const selectedDifficultyKey = difficultyOptions.querySelector('input[name="difficulty"]:checked').value;
        selectedDifficulty = selectedDifficultyKey;

        const size = DIFFICULTY_SETTINGS[selectedDifficulty];
        GRID_COLS = size.cols;
        GRID_ROWS = size.rows;
        
        // CSSå¤‰æ•°ã‚’æ›´æ–°ã—ã¦ãƒãƒƒã‚°ã®ã‚µã‚¤ã‚ºã‚’åæ˜ 
        document.documentElement.style.setProperty('--grid-cols', GRID_COLS);
        document.documentElement.style.setProperty('--grid-rows', GRID_ROWS);

        // 2. ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®åˆæœŸåŒ–
        grid = Array(GRID_ROWS).fill(0).map(() => Array(GRID_COLS).fill(0));
        placedItems = [];
        score = 0;
        isGameOver = false;
        currentPiece = null;
        currentPieceId = 1; // 1ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
        currentPlacement = { row: -1, col: -1 };
        bagElement.innerHTML = '';
        restartButton.classList.add('hidden');
        reportModal.classList.add('hidden'); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤ºã«

        // 3. UIã®åˆ‡ã‚Šæ›¿ãˆã¨æ›´æ–°
        settingsScreen.classList.add('hidden');
        gameScreen.classList.remove('hidden');
        currentScenarioDisplay.textContent = SCENARIOS[selectedScenario].name;
        currentSeasonDisplay.textContent = SEASONS[selectedSeason].name;
        currentDifficultyDisplay.textContent = DIFFICULTY_SETTINGS[selectedDifficulty].name;

        // 4. ã‚°ãƒªãƒƒãƒ‰ã®æç”»
        renderInitialBagGrid();
        updateScore();
        generateNextPiece();
    }
    
    /**
     * ãƒãƒƒã‚°ã®åˆæœŸã‚°ãƒªãƒƒãƒ‰ã‚»ãƒ«ã‚’DOMã«æç”»ã—ã¾ã™ã€‚
     */
    function renderInitialBagGrid() {
        bagElement.innerHTML = '';
        // bagElementã®å¹…ã¨é«˜ã•ã‚’å‹•çš„ã«è¨­å®š
        bagElement.style.width = `${GRID_COLS * CELL_SIZE}px`;
        bagElement.style.height = `${GRID_ROWS * CELL_SIZE}px`;

        for (let r = 0; r < GRID_ROWS; r++) {
            for (let c = 0; c < GRID_COLS; c++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.style.top = `${r * CELL_SIZE}px`;
                cell.style.left = `${c * CELL_SIZE}px`;
                cell.dataset.row = r;
                cell.dataset.col = c;
                cell.addEventListener('click', handleCellClick);
                bagElement.appendChild(cell);
            }
        }
    }

    /**
     * ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°ã—ã€DOMã«åæ˜ ã—ã¾ã™ã€‚
     */
    function updateScore() {
        scoreElement.textContent = score;
        if (score < 0) {
            scoreElement.classList.remove('text-green-600', 'text-yellow-600');
            scoreElement.classList.add('text-red-600');
        } else if (score < 50) {
            scoreElement.classList.remove('text-green-600', 'text-red-600');
            scoreElement.classList.add('text-yellow-600');
        } else {
            scoreElement.classList.remove('text-yellow-600', 'text-red-600');
            scoreElement.classList.add('text-green-600');
        }
    }


    /**
     * æ¬¡ã«è©°ã‚ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠã—ã€è¡¨ç¤ºã—ã¾ã™ã€‚
     */
    function generateNextPiece() {
        removeHighlight();
        
        // ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
        const randomIndex = Math.floor(Math.random() * BASE_ITEMS.length);
        const basePiece = BASE_ITEMS[randomIndex];
        
        // ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆã—ã€IDã‚’å‰²ã‚Šå½“ã¦ã‚‹
        currentPiece = { ...basePiece, id: currentPieceId }; 
        currentPieceId++;
        
        // â˜…â˜…â˜… å¤‰æ›´ç‚¹: ã‚·ãƒŠãƒªã‚ªã¨å­£ç¯€ã«å¿œã˜ãŸé‡è¦åº¦ã®è¨ˆç®— â˜…â˜…â˜…
        const scenario = SCENARIOS[selectedScenario];
        const season = SEASONS[selectedSeason];

        const scenarioModifier = scenario.modifiers[currentPiece.name] || 1.0;
        const seasonModifier = season.modifiers[currentPiece.name] || 1.0;
        
        // å®ŸåŠ¹é‡è¦åº¦ (ãƒ™ãƒ¼ã‚¹é‡è¦åº¦ * ã‚·ãƒŠãƒªã‚ªä¿®æ­£ * å­£ç¯€ä¿®æ­£)
        const effectiveImportance = Math.round(currentPiece.importance * scenarioModifier * seasonModifier);
        currentPiece.effectiveImportance = effectiveImportance;

        // UIè¡¨ç¤ºã®æ›´æ–°
        nextItemNameElement.textContent = currentPiece.name;
        dynamicImportanceElement.textContent = `å®ŸåŠ¹é‡è¦åº¦: ${effectiveImportance >= 0 ? '+' : ''}${effectiveImportance}`;
        dynamicImportanceElement.className = `font-bold ${effectiveImportance >= MIN_REQUIRED_IMPORTANCE ? 'text-red-500' : effectiveImportance > 0 ? 'text-green-600' : 'text-gray-500'}`;
        
        // ã‚¢ã‚¤ãƒ†ãƒ èª¬æ˜ã®æ›´æ–°
        itemDescriptionElement.textContent = currentPiece.description;
        itemRationaleElement.textContent = currentPiece.rationale;

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æç”»
        renderPiecePreview(currentPiece);
        
        // é¸æŠè‚¢UIã®ç”Ÿæˆ
        renderChoiceControls(currentPiece);

        // é…ç½®å¯èƒ½ãªå ´æ‰€ãŒä¸€ã¤ã‚‚ãªã‘ã‚Œã°ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
        if (!canPlaceAnywhere(currentPiece)) {
            gameOver();
            return;
        }

        messageElement.textContent = `ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’è©°ã‚ã‚‹ã‹ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã‹é¸æŠã—ã¦ãã ã•ã„ã€‚ã¾ãšãƒãƒƒã‚°å†…ã®é…ç½®å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆã—ã¦ãã ã•ã„ã€‚`;
    }

    /**
     * æŒ‡å®šã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ãŒãƒãƒƒã‚°å†…ã®ã©ã“ã«ã‚‚é…ç½®ã§ãã‚‹å ´æ‰€ãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
     */
    function canPlaceAnywhere(piece) {
        for (let r = 0; r < GRID_ROWS; r++) {
            for (let c = 0; c < GRID_COLS; c++) {
                // startRow=r, startCol=c ã§è¡çªãŒãªã‘ã‚Œã°é…ç½®å¯èƒ½
                if (checkCollision(piece, r, c)) {
                    return true;
                }
            }
        }
        return false;
    }

    /**
     * ãƒ”ãƒ¼ã‚¹ã‚’æŒ‡å®šã•ã‚ŒãŸé–‹å§‹ã‚°ãƒªãƒƒãƒ‰ä½ç½®ã«é…ç½®ã§ãã‚‹ã‹ï¼ˆè¡çªãŒãªã„ã‹ï¼‰ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
     * è¡çªãŒãªã„å ´åˆã¯ true (é…ç½®å¯èƒ½)ã€è¡çªãŒã‚ã‚‹å ´åˆã¯ falseã€‚
     */
    function checkCollision(piece, startRow, startCol) {
        const shape = piece.shape;
        for (const [r, c] of shape) {
            const row = startRow + r;
            const col = startCol + c;

            // 1. ãƒãƒƒã‚°ã®å¢ƒç•Œå¤–ã«å‡ºã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (row < 0 || row >= GRID_ROWS || col < 0 || col >= GRID_COLS) {
                return false;
            }

            // 2. æ—¢å­˜ã®ã‚¢ã‚¤ãƒ†ãƒ ã¨é‡ãªã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ (0ã¯ç©ºã)
            if (grid[row][col] !== 0) {
                return false;
            }
        }
        return true;
    }

    /**
     * ã‚°ãƒªãƒƒãƒ‰ã‚»ãƒ«ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã®ãƒãƒ³ãƒ‰ãƒ© (é…ç½®å ´æ‰€ã®é¸æŠã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆ)ã€‚
     */
    function handleCellClick(e) {
        if (isGameOver || !currentPiece) return;

        const startRow = parseInt(e.target.dataset.row, 10);
        const startCol = parseInt(e.target.dataset.col, 10);

        // é…ç½®å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
        if (checkCollision(currentPiece, startRow, startCol)) {
            removeHighlight();
            currentPlacement = { row: startRow, col: startCol };
            highlightPlacement(currentPiece, startRow, startCol);
            
            messageElement.textContent = `(${startRow}, ${startCol}) ã‚’é…ç½®å ´æ‰€ã«é¸ã³ã¾ã—ãŸã€‚å·¦ã®ã€Œè©°ã‚ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚`;

            const placeButton = choiceAreaElement.querySelector('#place-button');
            if(placeButton) placeButton.disabled = false;

        } else {
            messageElement.textContent = 'ãã“ã«ã¯è©°ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ï¼ä»–ã®å ´æ‰€ã‚’æ¢ã—ã¦ãã ã•ã„ã€‚';
            const placeButton = choiceAreaElement.querySelector('#place-button');
            if(placeButton) placeButton.disabled = true;
        }
    }
    
    /**
     * ãƒ”ãƒ¼ã‚¹ã®é…ç½®å ´æ‰€ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã—ã¾ã™ã€‚
     */
    function highlightPlacement(piece, startRow, startCol) {
        piece.shape.forEach(([r, c]) => {
            const row = startRow + r;
            const col = startCol + c;
            const cellElement = bagElement.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            if (cellElement) {
                cellElement.style.outline = `3px dashed ${piece.color}`;
                cellElement.style.zIndex = 4;
            }
        });
    }

    /**
     * ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤ã—ã€é…ç½®ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚
     */
    function removeHighlight() {
        bagElement.querySelectorAll('.grid-cell').forEach(cell => {
            cell.style.outline = 'none';
            cell.style.zIndex = 3;
        });
        currentPlacement = { row: -1, col: -1 };
    }


    /**
     * ãƒ”ãƒ¼ã‚¹ã‚’ã‚°ãƒªãƒƒãƒ‰ã«å›ºå®šã—ã€ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°ã—ã¾ã™ã€‚
     */
    function placePiece(piece, startRow, startCol) {
        const shape = piece.shape;
        const color = piece.color;

        for (const [r, c] of shape) {
            const row = startRow + r;
            const col = startCol + c;
            
            grid[row][col] = piece.id; // ã‚¢ã‚¤ãƒ†ãƒ IDã§ã‚°ãƒªãƒƒãƒ‰ã‚’åŸ‹ã‚ã‚‹

            const cellElement = bagElement.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            if (cellElement) {
                cellElement.classList.add('item');
                cellElement.style.backgroundColor = color;
                cellElement.dataset.name = piece.name;
                cellElement.style.outline = 'none';
            }
        }

        // è©°ã‚ãŸã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼ˆãƒ¬ãƒãƒ¼ãƒˆç”¨ï¼‰
        placedItems.push(piece);
        score += piece.effectiveImportance; // å‹•çš„ã«è¨ˆç®—ã•ã‚ŒãŸé‡è¦åº¦ã‚’åŠ ç®—
        updateScore();
    }
    
    /**
     * ã‚¢ã‚¤ãƒ†ãƒ é¸æŠè‚¢ã®æ“ä½œãƒœã‚¿ãƒ³ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚
     */
    function renderChoiceControls(piece) {
        choiceAreaElement.innerHTML = '';
        
        const placeButton = document.createElement('button');
        placeButton.id = 'place-button';
        placeButton.className = 'w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 disabled:opacity-50 text-base';
        placeButton.textContent = 'é¸ã‚“ã å ´æ‰€ã«è©°ã‚ã‚‹';
        placeButton.disabled = true;
        placeButton.addEventListener('click', handlePlaceItem);

        const skipButton = document.createElement('button');
        skipButton.id = 'skip-button';
        skipButton.className = 'w-full sm:w-auto bg-yellow-500 hover:bg-yellow-600 text-gray-800 font-bold py-3 px-6 rounded-lg shadow-lg transition duration-300 text-base mt-2 sm:mt-0';
        skipButton.textContent = 'ã‚¹ã‚­ãƒƒãƒ— (è©°ã‚ã‚‹ã®ã‚’ã‚„ã‚ã‚‹)';
        skipButton.addEventListener('click', handleSkipItem);

        choiceAreaElement.appendChild(placeButton);
        choiceAreaElement.appendChild(skipButton);
    }
    
    /**
     * è©°ã‚ã‚‹ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†ã€‚
     */
    function handlePlaceItem() {
        if (currentPlacement.row === -1) {
            messageElement.textContent = 'ã¾ãšã€ãƒãƒƒã‚°å†…ã®é…ç½®å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸ã‚“ã§ãã ã•ã„ï¼';
            return;
        }

        if (checkCollision(currentPiece, currentPlacement.row, currentPlacement.col)) {
            placePiece(currentPiece, currentPlacement.row, currentPlacement.col);
            messageElement.textContent = `${currentPiece.name} ã‚’è©°ã‚ã¾ã—ãŸï¼ (ã‚¹ã‚³ã‚¢${currentPiece.effectiveImportance >= 0 ? '+' : ''}${currentPiece.effectiveImportance})`;
            generateNextPiece(); 
        } else {
            messageElement.textContent = 'ã‚¨ãƒ©ãƒ¼: é¸æŠã—ãŸå ´æ‰€ã«é…ç½®ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
            removeHighlight();
        }
    }

    /**
     * ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†ã€‚
     */
    function handleSkipItem() {
        removeHighlight();
        
        const effectiveImportance = currentPiece.effectiveImportance;
        
        if (effectiveImportance >= MIN_REQUIRED_IMPORTANCE) {
             messageElement.textContent = `${currentPiece.name} (é‡è¦åº¦:${effectiveImportance}) ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚å¤§ããªå¾—ç‚¹ãƒãƒ£ãƒ³ã‚¹ã‚’é€ƒã—ã¾ã—ãŸãŒã€ã‚¹ãƒšãƒ¼ã‚¹ã¯æ®‹ã‚Šã¾ã—ãŸã€‚`;
        } else if (effectiveImportance <= 0) {
             messageElement.textContent = `${currentPiece.name} (é‡è¦åº¦:${effectiveImportance}) ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚å®¹é‡ã‚’æµªè²»ã—ãªãã¦è³¢æ˜ã§ã™ï¼`;
        } else {
             messageElement.textContent = `${currentPiece.name} (é‡è¦åº¦:${effectiveImportance}) ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚`;
        }
        
        generateNextPiece();
    }

    /**
     * ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†ã€‚
     */
    function gameOver() {
        isGameOver = true;
        messageElement.innerHTML = `<span class="text-red-600">ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼</span> ã“ã‚Œä»¥ä¸Šã¯è©°ã‚ã‚‰ã‚Œã¾ã›ã‚“ã€‚ãƒ¬ãƒãƒ¼ãƒˆä½œæˆä¸­...`;
        
        currentPiece = null;
        nextItemNameElement.textContent = 'ãªã—';
        dynamicImportanceElement.textContent = '';
        itemDescriptionElement.textContent = 'ã‚²ãƒ¼ãƒ çµ‚äº†';
        itemRationaleElement.textContent = 'ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„';
        nextItemPreviewElement.innerHTML = '<div class="text-gray-500">ã‚²ãƒ¼ãƒ çµ‚äº†</div>';
        choiceAreaElement.innerHTML = '';
        
        bagElement.querySelectorAll('.grid-cell').forEach(cell => {
            cell.removeEventListener('click', handleCellClick);
        });

        // ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
        generateReport();
    }

    /**
     * ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã«é˜²ç½æ•™è‚²ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤ºã—ã¾ã™ã€‚
     */
    function generateReport() {
        // 1. ç›®æ¨™ã‚¹ã‚³ã‚¢ã®è¨ˆç®—ã¨å¿…é ˆã‚¢ã‚¤ãƒ†ãƒ ã®æŠ½å‡º
        let targetScore = 0;
        const requiredItems = [];
        const requiredItemNames = [];
        const placedItemNames = placedItems.map(item => item.name);

        BASE_ITEMS.forEach(item => {
            const scenario = SCENARIOS[selectedScenario];
            // â˜…â˜…â˜… å¤‰æ›´ç‚¹: å­£ç¯€ã‚’å–å¾— â˜…â˜…â˜…
            const season = SEASONS[selectedSeason];
            
            const scenarioModifier = scenario.modifiers[item.name] || 1.0;
            // â˜…â˜…â˜… å¤‰æ›´ç‚¹: å­£ç¯€ã®ä¿®æ­£å­ã‚’å–å¾— â˜…â˜…â˜…
            const seasonModifier = season.modifiers[item.name] || 1.0;
            
            // â˜…â˜…â˜… å¤‰æ›´ç‚¹: å­£ç¯€ã®ä¿®æ­£å­ã‚‚ä¹—ç®— â˜…â˜…â˜…
            const effectiveImportance = Math.round(item.importance * scenarioModifier * seasonModifier);
            
            // é‡è¦åº¦ãŒMIN_REQUIRED_IMPORTANCEä»¥ä¸Šã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å¿…é ˆã¨è¦‹ãªã™
            if (effectiveImportance >= MIN_REQUIRED_IMPORTANCE) {
                targetScore += effectiveImportance;
                requiredItems.push({ ...item, effectiveImportance });
                requiredItemNames.push(item.name);
            }
        });

        // 2. é”æˆåº¦ã®è¨ˆç®—
        const achievement = targetScore > 0 ? Math.min(100, Math.round((score / targetScore) * 100)) : 100;

        // 3. ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ç”Ÿæˆ
        const feedback = [];
        const missingItems = requiredItems.filter(item => !placedItemNames.includes(item.name));
        const wasteItems = placedItems.filter(item => item.category === "Waste" || (item.category === "NonEssential" && item.effectiveImportance < 5));
        
        // å¿…é ˆã‚¢ã‚¤ãƒ†ãƒ ã®ä¸è¶³
        if (missingItems.length > 0) {
            feedback.push({
                type: 'bad',
                title: 'âŒ å¿…é ˆã‚¢ã‚¤ãƒ†ãƒ ã®ä¸è¶³',
                // â˜…â˜…â˜… å¤‰æ›´ç‚¹: å­£ç¯€ã‚’ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã«è¿½åŠ  â˜…â˜…â˜…
                details: `ä»Šå›ã®**ã€Œ${SCENARIOS[selectedScenario].name}ã€(${SEASONS[selectedSeason].name})**ã‚·ãƒŠãƒªã‚ªã«ãŠã„ã¦ã€ä»¥ä¸‹ã®é‡è¦ã‚¢ã‚¤ãƒ†ãƒ ãŒãƒãƒƒã‚°ã«ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã“ã‚Œã‚‰ãŒä¸è¶³ã™ã‚‹ã¨ã€ç”Ÿå­˜ç‡ãŒå¤§å¹…ã«ä½ä¸‹ã™ã‚‹æã‚ŒãŒã‚ã‚Šã¾ã™ã€‚`,
                items: missingItems.map(item => `${item.name} (é‡è¦åº¦: ${item.effectiveImportance})`)
            });
        } else {
            feedback.push({
                type: 'good',
                title: 'âœ… å¿…é ˆã‚¢ã‚¤ãƒ†ãƒ ã®ç¢ºä¿',
                details: 'ä»Šå›ã®ã‚·ãƒŠãƒªã‚ªã§å¿…è¦ãªæœ€é‡è¦ã‚¢ã‚¤ãƒ†ãƒ ã¯å…¨ã¦ç¢ºä¿ã§ãã¦ã„ã¾ã™ã€‚ç´ æ™´ã‚‰ã—ã„åˆ¤æ–­ã§ã™ï¼',
                items: []
            });
        }

        // ä¸è¦ãªã‚¢ã‚¤ãƒ†ãƒ ã®é…ç½®
        if (wasteItems.length > 0) {
            feedback.push({
                type: 'bad',
                title: 'âš ï¸ å®¹é‡ã‚’æµªè²»ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ',
                details: `ä»¥ä¸‹ã®ã‚¢ã‚¤ãƒ†ãƒ ã¯ã€ä»Šå›ã®ç½å®³ã‚·ãƒŠãƒªã‚ªã§ã¯é‡è¦åº¦ãŒä½ã„ï¼ˆã¾ãŸã¯ãƒã‚¤ãƒŠã‚¹ï¼‰ã«ã‚‚é–¢ã‚ã‚‰ãšã€è²´é‡ãªãƒãƒƒã‚°ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’å æœ‰ã—ã¾ã—ãŸã€‚`,
                items: wasteItems.map(item => `${item.name} (ã‚¹ã‚³ã‚¢: ${item.effectiveImportance}) - ${item.rationale}`)
            });
        }
        
        // ã‚¹ã‚³ã‚¢ã«åŸºã¥ã„ãŸç·è©•
        let summary = '';
        if (achievement >= 90 && wasteItems.length === 0) {
            summary = 'ğŸ¥‡ å®Œç’§ã§ã™ï¼ç›®æ¨™ã‚¹ã‚³ã‚¢ã‚’å¤§ããä¸Šå›ã‚Šã€å¿…é ˆã‚¢ã‚¤ãƒ†ãƒ ã‚’å…¨ã¦ç¢ºä¿ã—ã€ç„¡é§„ãªã‚¢ã‚¤ãƒ†ãƒ ã‚‚ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
        } else if (achievement >= 70) {
            summary = 'ğŸ¥ˆ éå¸¸ã«å„ªç§€ã§ã™ã€‚ä¸»è¦ãªã‚¢ã‚¤ãƒ†ãƒ ã¯æƒã£ã¦ãŠã‚Šã€å®Ÿç”¨çš„ãªãƒãƒƒã‚°ãŒå®Œæˆã—ã¾ã—ãŸã€‚ã‚ãšã‹ãªæ”¹å–„ç‚¹ã®ã¿ã§ã™ã€‚';
        } else if (achievement >= 50) {
            summary = 'ğŸ¥‰ ã¾ãšã¾ãšã§ã™ã€‚åŸºæœ¬çš„ãªç”Ÿå­˜ã¯å¯èƒ½ã§ã™ãŒã€ç‰¹å®šã®ã‚·ãƒŠãƒªã‚ªã«å¯¾å¿œã™ã‚‹ãŸã‚ã®é‡è¦ã‚¢ã‚¤ãƒ†ãƒ ãŒã„ãã¤ã‹ä¸è¶³ã—ã¦ã„ã¾ã™ã€‚';
        } else {
            summary = 'ğŸ˜­ è¦æ”¹å–„ã§ã™ã€‚ãƒãƒƒã‚°ã®å®¹é‡ã‚’åŠ¹ç‡çš„ã«ä½¿ãˆãšã€å¿…é ˆã¨ãªã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã®å¤šãã‚’ç¢ºä¿ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ã€ã‚¢ã‚¤ãƒ†ãƒ ã®å„ªå…ˆé †ä½ã‚’è¦‹ç›´ã—ã¾ã—ã‚‡ã†ã€‚';
        }

        // 4. ãƒ¢ãƒ¼ãƒ€ãƒ«ã¸ã®è¡¨ç¤º
        
        // é”æˆåº¦è¡¨ç¤º (å††ã‚°ãƒ©ãƒ•é¢¨)
        let achievementColor = achievement >= 70 ? 'text-green-600' : achievement >= 50 ? 'text-yellow-600' : 'text-red-600';
        reportAchievment.innerHTML = `
            <div class="inline-flex items-center justify-center p-8 rounded-full border-8 border-gray-200"
                 style="background: conic-gradient(var(--tw-c-achievement) 0% ${achievement}%, #e5e7eb ${achievement}% 100%); 
                        --tw-c-achievement: ${achievement >= 70 ? '#10b981' : achievement >= 50 ? '#fbbf24' : '#ef4444'};">
                <div class="flex flex-col items-center justify-center bg-white w-28 h-28 rounded-full shadow-lg">
                    <span class="text-4xl font-extrabold ${achievementColor}">${achievement}%</span>
                    <span class="text-sm font-medium text-gray-500">å¯¾å¿œåº¦</span>
                </div>
            </div>
            <p class="mt-4 text-xl font-bold ${achievementColor}">${summary}</p>
        `;
        
        // è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
        feedbackContent.innerHTML = '';
        feedback.forEach(item => {
            const div = document.createElement('div');
            div.className = `p-4 mt-3 rounded-lg border-l-4 ${item.type === 'good' ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500'}`;
            div.innerHTML = `
                <p class="font-bold text-lg mb-1 ${item.type === 'good' ? 'text-green-700' : 'text-red-700'}">${item.title}</p>
                <p class="text-sm text-gray-600 mb-2">${item.details}</p>
                ${item.items.length > 0 ? `<ul class="list-disc list-inside text-sm text-gray-800 ml-4">${item.items.map(i => `<li>${i}</li>`).join('')}</ul>` : ''}
            `;
            feedbackContent.appendChild(div);
        });
        
        // æœ€çµ‚ã‚¹ã‚³ã‚¢è¡¨ç¤º
        reportScenario.textContent = SCENARIOS[selectedScenario].name;
        // â˜…â˜…â˜… å¤‰æ›´ç‚¹: å­£ç¯€ã‚’ãƒ¬ãƒãƒ¼ãƒˆã«è¡¨ç¤º â˜…â˜…â˜…
        reportSeason.textContent = SEASONS[selectedSeason].name;
        reportFinalScore.textContent = score;

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        reportModal.classList.remove('hidden');
    }

    /**
     * ãƒ”ãƒ¼ã‚¹ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’DOMã«æç”»ã—ã¾ã™ã€‚
     */
    function renderPiecePreview(piece) {
        nextItemPreviewElement.innerHTML = '';
        
        let maxRow = 0;
        let maxCol = 0;
        piece.shape.forEach(([r, c]) => {
            maxRow = Math.max(maxRow, r);
            maxCol = Math.max(maxCol, c);
        });

        const container = document.createElement('div');
        container.className = 'piece-container';
        container.style.gridTemplateColumns = `repeat(${maxCol + 1}, ${CELL_SIZE}px)`;
        
        const previewGrid = Array(maxRow + 1).fill(0).map(() => Array(maxCol + 1).fill(0));
        
        piece.shape.forEach(([r, c]) => {
            if (r <= maxRow && c <= maxCol) {
                previewGrid[r][c] = 1;
            }
        });

        for (let r = 0; r <= maxRow; r++) {
            for (let c = 0; c <= maxCol; c++) {
                const cell = document.createElement('div');
                cell.className = 'piece-cell';
                if (previewGrid[r][c] === 1) {
                    cell.style.backgroundColor = piece.color;
                    cell.classList.add('shadow-md');
                } else {
                    cell.style.backgroundColor = 'transparent'; 
                    cell.style.border = '1px solid transparent';
                }
                container.appendChild(cell);
            }
        }

        nextItemPreviewElement.appendChild(container);
    }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
    
    // è¨­å®šã‚’ãƒ­ãƒ¼ãƒ‰
    loadSettingsUI();
    
    // ã‚²ãƒ¼ãƒ é–‹å§‹ãƒœã‚¿ãƒ³
    startGameButton.addEventListener('click', initGame);

    // ãƒªã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ (è¨­å®šç”»é¢ã«æˆ»ã‚‹)
    restartButton.addEventListener('click', () => {
        gameScreen.classList.add('hidden');
        settingsScreen.classList.remove('hidden');
        loadSettingsUI();
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ (è¨­å®šç”»é¢ã«æˆ»ã‚‹)
    closeReportButton.addEventListener('click', () => {
        reportModal.classList.add('hidden');
        gameScreen.classList.add('hidden');
        settingsScreen.classList.remove('hidden');
        loadSettingsUI();
    });

    // åˆæœŸèµ·å‹•æ™‚ã¯è¨­å®šç”»é¢ã‚’è¡¨ç¤º
    gameScreen.classList.add('hidden');
</script>

</body>
</html>
